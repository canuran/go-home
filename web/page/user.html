<div class="layuimini-main">

    <form class="layui-form layui-form-pane">
        <div class="layui-form-item" style="margin-bottom:5px">
            <div class="layui-inline">
                <label class="layui-form-label" style="width: 88px">用户ID</label>
                <div class="layui-input-inline" style="width: 100px">
                    <input type="number" name="id" class="layui-input"/>
                </div>
            </div>

            <div class="layui-inline">
                <label class="layui-form-label" style="width: 88px">用户名</label>
                <div class="layui-input-inline" style="width: 150px">
                    <input type="text" name="name" class="layui-input"/>
                </div>
            </div>

            <div class="layui-inline">
                <button type="submit" class="layui-btn" lay-submit lay-filter="search-btn">
                    <i class="fa fa-search"></i>搜索
                </button>
            </div>

            <div class="layui-inline">
                <button type="button" class="layui-btn layui-btn-normal" onclick="openEditWin()">
                    <i class="fa fa-plus"></i>添加
                </button>
            </div>
        </div>
    </form>

    <table id='main-table'></table>
</div>

<!--表单窗口-->
<template id="main-edit-win">
    <div class="layuimini-main">
        <form id="main-edit-form" class="layui-form layui-form-pane" lay-filter="main-edit-form">
            <input type="hidden" name="id" value="0"/>
            <div class="layui-form-item">
                <label class="layui-form-label">用户名</label>
                <div class="layui-input-block">
                    <input type="text" name="name" class="layui-input" placeholder="请输入用户名" lay-verify="required"/>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">新密码</label>
                <div class="layui-input-block">
                    <input type="password" name="password" class="layui-input" placeholder="请输入新密码"/>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">新头像</label>
                <div class="layui-input-block">
                    <input id="form-header-img" type="file" name="header_file" style="display:none"
                           onchange="$('#show-header-img').val($(this).val())"/>
                    <input id="show-header-img" class="layui-input" style="cursor:pointer"
                           placeholder="请选择新头像" onclick="$('#form-header-img').click()" readonly/>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">性别</label>
                <div class="layui-input-block">
                    <select name="gender" lay-verify="required">
                        <option value="保密" selected>保密</option>
                        <option value="男">男</option>
                        <option value="女">女</option>
                    </select>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">角色</label>
                <div class="layui-input-block">
                    <select id="select_role" name="role" lay-verify="required">
                    </select>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">状态</label>
                <div class="layui-input-block">
                    <select name="status" lay-verify="required">
                        <option value="1" selected>有效</option>
                        <option value="2">无效</option>
                    </select>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">签名</label>
                <div class="layui-input-block">
                    <textarea name="sign" class="layui-textarea" style="resize:none"
                              placeholder="请输入签名" lay-verify="required"></textarea>
                </div>
            </div>

            <div class="layui-form-item">
                <div style="text-align: center;margin-top: 50px">
                    <button type="submit" class="layui-btn layui-btn-normal" lay-submit lay-filter="main-edit-ok">
                        <i class="fa fa-check"></i>确定
                    </button>

                    <button type="button" style="margin-left:50px" class="layui-btn layui-btn-warm"
                            onclick="layui.layer.closeAll()">
                        <i class="fa fa-close"></i>取消
                    </button>
                </div>
            </div>
        </form>
    </div>
</template>

<script type="application/javascript">
    layui.use(['form', 'layer', 'element'], ready);

    var statuses = {
        0: '<font color="gray">未知</font>',
        1: '<font color="green">有效</font>',
        2: '<font color="red">无效</font>'
    }

    function statusTemplate(cell, row) {
        return statuses[row.status || 0] || row.status;
    }

    function ready() {
        // 监听搜索按钮
        layui.form.on('submit(search-btn)', function (form) {
            GridManager.setQuery('main-table', form.field);
            return false;
        });

        loadTable({url: srvPath + "/user/query"});
    }

    function initSelect() {
        var roles = ["", "管理员", "前端", "后端", "产品", "测试"]
        roles.forEach(function (value) {
            $("#select_role").append("<option value='" + value + "'>" + value + "</option>");
        })
        layui.form.render();
    }

    // 加载表格
    function loadTable(options) {
        // 单页面可能需要重新刷新
        GridManager.destroy('main-table');
        var offset = $('#main-table').offset().top + 10;
        document.querySelector('#main-table').GM({
            gridManagerName: 'main-table',
            ajaxData: options.url,
            query: options.query,
            ajaxType: 'GET',
            height: '100vh - ' + offset + 'px',
            width: '100%',
            supportAjaxPage: true,
            sizeData: [10, 20, 100, 500, 1000],
            supportCheckbox: false,
            supportMenu: true,
            useWordBreak: true,
            disableLine: true,
            supportAutoOrder: false, asyncTotals: {
                text: '<span>加载中</span>',
                handler: ajaxGetTotals
            },
            columnData: [
                {key: 'id', text: '用户ID', width: '100px', fixed: 'left'},
                {key: 'header', text: '用户头像', width: '123px', fixed: 'left', template: gmImageTemplate},
                {key: 'name', text: '用户名', width: '200px'},
                {key: 'status', text: '状态', width: '200px', template: statusTemplate},
                {key: 'gender', text: '性别', width: '200px'},
                {key: 'role', text: '角色', width: '200px'},
                {key: 'sign', text: '签名', width: '300px'},
                {key: 'updated_at', text: '更新时间', width: '200px', template: gmTimeTemplate},
                {key: '_operate_', text: '操作', width: '135px', fixed: 'right', template: rowOperates}
            ]
        });
    }

    function rowOperates() {
        return '<button class="layui-btn layui-btn-normal layui-btn-xs" ' +
            'onclick="openEditWin(this)">' +
            '<span class="fa fa-pencil"/>修改</button>' +
            '<button class="layui-btn layui-btn-danger layui-btn-xs" ' +
            'onclick="deleteAction(this)">' +
            '<span class="fa fa-remove"/>删除</button>';
    }

    // 打开编辑窗口
    function openEditWin(btn) {
        layui.layer.open({
            id: 'main-edit-win-open',
            title: '<i class="fa fa-list"></i> 表单数据',
            offset: '160px',
            area: '600px',
            type: 1,
            content: $('#main-edit-win').html()
        });
        initSelect();
        if (btn) {
            var row = GridManager.getRowData('main-table', btn.parentElement.parentElement);
            row.header_file = "";
            layui.form.val('main-edit-form', row);
        }
        // 监听编辑提交
        layui.form.on('submit(main-edit-ok)', editFormSubmit);
        layui.form.render();
    }

    // 编辑提交按钮
    function editFormSubmit(form) {
        var data = form.field;
        data.id = parseInt(data.id) || 0;
        data.valid_status = parseInt(data.valid_status) || 0;
        $.ajax({
            url: srvPath + "/user/save",
            method: "post",
            processData: false,
            contentType: false,
            data: new FormData($('#main-edit-form')[0]),
            dataType: "json",
            success: function (result) {
                if (result && result.code === 0) {
                    layui.layer.closeAll();
                    GridManager.refreshGrid('main-table');
                    layui.layer.msg("保存成功", {icon: 1});
                } else {
                    layui.layer.msg(result.message, {icon: 2});
                }
            }
        });
        return false;
    }

    // 删除操作
    function deleteAction(btn) {
        var row = GridManager.getRowData('main-table', btn.parentElement.parentElement);
        layui.layer.confirm('你确定要删除' + row.id + '?', {
            title: '<i class="fa fa-remove"></i> 确认删除',
            icon: 3
        }, function () {
            $.ajax({
                url: srvPath + "/user/delete",
                method: "post",
                data: {id: row.id},
                dataType: "json",
                success: function (result) {
                    if (result && result.code === 0) {
                        layui.layer.closeAll();
                        GridManager.refreshGrid('main-table');
                        layui.layer.msg("删除成功", {icon: 1});
                    } else {
                        layui.layer.msg(result.message, {icon: 2});
                    }
                }
            });
        });
    }
</script>