<div class="layuimini-main">

    <form class="layui-form layui-form-pane">
        <div class="layui-form-item">
            <div class="layui-inline">
                <label class="layui-form-label">用户ID</label>
                <div class="layui-input-inline" style="width: 100px">
                    <input type="number" name="id" class="layui-input"/>
                </div>
            </div>

            <div class="layui-inline">
                <label class="layui-form-label">用户名称</label>
                <div class="layui-input-inline" style="width: 100px">
                    <input type="text" name="name" class="layui-input"/>
                </div>
            </div>

            <div class="layui-inline">
                <button id="search-btn" type="submit" class="layui-btn layui-btn-primary"
                        lay-submit lay-filter="search-btn">
                    <i class="fa fa-search"></i>搜索
                </button>
            </div>

            <div class="layui-inline">
                <button id="main-add" type="button" class="layui-btn layui-btn-normal">
                    <i class="fa fa-plus"></i>添加
                </button>
            </div>
        </div>
    </form>

    <table id='main-table'></table>
</div>

<!--表单窗口-->
<div id="main-edit-win" hidden="hidden">
    <div class="layuimini-main">
        <form id="main-edit-form" class="layui-form layui-form-pane" lay-filter="main-edit-form">
            <input type="hidden" name="id"/>
            <div class="layui-form-item">
                <label class="layui-form-label">用户名称</label>
                <div class="layui-input-block">
                    <input type="text" name="name" class="layui-input"
                           placeholder="请输入用户名称" lay-verify="required"/>
                </div>
            </div>

            <input type="hidden" name="header"/>
            <div class="layui-form-item">
                <label class="layui-form-label">用户头像</label>
                <div class="layui-input-block">
                    <input id="form-header-img" type="file" name="header_img" 
                        class="layui-input" placeholder="请选择头像图片"/>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">性别</label>
                <div class="layui-input-block">
                    <select name="gender" lay-verify="required">
                        <option value="保密" selected>保密</option>
                        <option value="男">男</option>
                        <option value="女">女</option>
                    </select>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">角色</label>
                <div class="layui-input-block">
                    <select id="select_role" name="role" lay-verify="required">
                    </select>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">状态</label>
                <div class="layui-input-block">
                    <select name="status" lay-verify="required">
                        <option value="1" selected>有效</option>
                        <option value="2">无效</option>
                    </select>
                </div>
            </div>

            <div class="layui-form-item">
                <div style="text-align: center;margin-top: 50px">
                    <button type="submit" class="layui-btn layui-btn-normal"
                            lay-submit lay-filter="main-edit-ok">
                        <i class="fa fa-check"></i>确定
                    </button>

                    <button id="main-edit-cancel" type="button" style="margin-left:50px"
                            class="layui-btn layui-btn-warm">
                        <i class="fa fa-close"></i>取消
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script type="application/javascript">
    layui.use(['form', 'layer', 'element'], ready);

    var statuses = {
        0: '<font color="gray">未知</font>',
        1: '<font color="green">有效</font>',
        2: '<font color="red">无效</font>'
    }

    function statusTemplate(cell, row) {
        return statuses[row.status || 0] || row.status;
    }

    function ready() {
        initSelect()
        // 监听搜索按钮
        layui.form.on('submit(search-btn)', function (form) {
            GridManager.setQuery('main-table', form.field);
            return false;
        });

        // 监听编辑提交
        layui.form.on('submit(main-edit-ok)', editFormSubmit);

        // 监听打开窗口
        $('#main-add').on('click', function (event) {
            openEditWin();
        });

        // 监听关闭窗口
        $('#main-edit-cancel').on('click', function () {
            layui.layer.closeAll();
        });

        loadTable({url: path + "user/query"});
    }

    function initSelect() {
        var roles = ["管理员", "前端", "后端", "产品", "测试"]
        roles.forEach(function (value) {
            $("#select_role").append("<option value='" + value + "'>" + value + "</option>");
        })
        layui.form.render();
    }

    // 加载表格
    function loadTable(options) {
        // 单页面可能需要重新刷新
        GridManager.destroy('main-table');
        var offset = $('#main-table').offset().top + 20;
        document.querySelector('#main-table').GM({
            gridManagerName: 'main-table',
            ajaxData: options.url,
            query: options.query,
            ajaxType: 'GET',
            height: '100vh - ' + offset + 'px',
            width: '100%',
            supportAjaxPage: true,
            sizeData: [10, 20, 100, 500, 1000],
            supportCheckbox: false,
            supportMenu: true,
            useWordBreak: true,
            disableLine: true,
            supportAutoOrder: false, asyncTotals: {
                text: '<span>加载中</span>',
                handler: ajaxGetTotals
            },
            columnData: [
                {key: 'id', text: '用户ID', width: '100px', fixed: 'left'},
                {key: 'header', text: '用户头像', width: '123px', fixed: 'left', template: gmImageTemplate},
                {key: 'name', text: '用户名称', width: '200px'},
                {key: 'gender', text: '性别', width: '200px'},
                {key: 'role', text: '角色', width: '200px'},
                {key: 'status', text: '状态', width: '200px', template: statusTemplate},
                {key: 'updated_at', text: '更新时间', width: '200px', template: gmTimeTemplate},
                {key: '_operate_', text: '操作', width: '135px', fixed: 'right', template: rowOperates}
            ]
        });
    }

    function rowOperates() {
        return '<button class="layui-btn layui-btn-normal layui-btn-xs" ' +
            'onclick="openEditWin(this)">' +
            '<span class="fa fa-edit"/>修改</button>' +
            '<button class="layui-btn layui-btn-danger layui-btn-xs" ' +
            'onclick="deleteAction(this)">' +
            '<span class="fa fa-remove"/>删除</button>';
    }

    // 打开编辑窗口
    function openEditWin(btn) {
        layui.layer.open({
            id: 'main-edit-win-open',
            title: '<i class="fa fa-list"></i> 表单数据',
            offset: '170px',
            area: '600px',
            zIndex: 10,
            type: 1,
            content: $('#main-edit-win')
        });

        if (btn) {
            var row = GridManager.getRowData('main-table', btn.parentElement.parentElement);
            row.header_img = "";
            layui.form.val('main-edit-form', row);
        } else {
            layui.form.val('main-edit-form', {
                id: 0,
                name: "",
                header: "",
                header_img: "",
                role: "",
                gender: "",
                status: "1"
            });
        }
    }

    // 编辑提交按钮
    function editFormSubmit(form) {
        var data = form.field;
        data.id = parseInt(data.id) || 0;
        data.valid_status = parseInt(data.valid_status) || 0;
        $.ajax({
            url: path + "user/save",
            method: "post",
            processData: false,
            contentType: false,
            data: new FormData($('#main-edit-form')[0]),
            dataType: "json",
            success: function (result) {
                if (result && result.code === 0) {
                    layui.layer.closeAll();
                    GridManager.refreshGrid('main-table');
                    layui.layer.msg("保存成功");
                } else {
                    layui.layer.msg(result.message);
                }
            },
            error: function () {
                layui.layer.msg('请求失败');
            }
        });
        return false;
    }

    // 删除操作
    function deleteAction(btn) {
        var row = GridManager.getRowData('main-table', btn.parentElement.parentElement);
        layui.layer.confirm('你确定要删除' + row.id + '?', {
            title: '<i class="fa fa-remove"></i> 确认删除',
            icon: 3
        }, function () {
            $.ajax({
                url: path + "user/delete",
                method: "post",
                data: {id: row.id},
                dataType: "json",
                success: function (result) {
                    if (result && result.code === 0) {
                        layui.layer.closeAll();
                        GridManager.refreshGrid('main-table');
                        layui.layer.msg("删除成功");
                    } else {
                        layui.layer.msg(result.message);
                    }
                },
                error: function () {
                    layui.layer.msg('请求失败');
                }
            });
        });
    }
</script>