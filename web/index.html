<!DOCTYPE html>
<html lang="cn">

<head>
    <meta charset="utf-8">
    <title>后端之家</title>
    <meta name="keywords" content="后端之家">
    <meta name="description" content="后端之家">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="icon" href="image/favicon.ico">
    <link rel="stylesheet" href="module/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="module/font-awesome/css/font-awesome.css" media="all">
    <link rel="stylesheet" href="module/layuimini/layuimini.css" media="all">
    <link rel="stylesheet" href="module/layuimini/themes/default.css" media="all">
    <link rel="stylesheet" href="module/GridManager/index.css" media="all">
    <style id="layuimini-bg-color"></style>
</head>

<body class="layui-layout-body layuimini-all">
<div class="layui-layout layui-layout-admin">

    <div class="layui-header header">
        <div class="layui-logo layuimini-logo layuimini-back-home"></div>

        <div class="layuimini-header-content">
            <a>
                <div class="layuimini-tool"><i title="展开" class="fa fa-outdent" data-side-fold="1"></i></div>
            </a>

            <!--电脑端头部菜单-->
            <ul class="layui-nav layui-layout-left layuimini-header-menu layuimini-menu-header-pc layuimini-pc-show"></ul>

            <!--手机端头部菜单-->
            <ul class="layui-nav layui-layout-left layuimini-header-menu layuimini-mobile-show">
                <li class="layui-nav-item">
                    <a><i class="fa fa-list-ul"></i> 模块导航</a>
                    <dl class="layui-nav-child layuimini-menu-header-mobile">
                    </dl>
                </li>
            </ul>

            <ul class="layui-nav layui-layout-right">
                <li id="user-profile" class="layui-nav-item layuimini-setting" style="margin-right:10px">
                    <a href="javascript:">
                        <span id="login-info"></span>
                    </a>
                    <dl class="layui-nav-child" hidden>
                        <dd><a layuimini-content-href="page/user/user-profile.html" data-title="基本资料"
                               data-icon="fa fa-gears">用户设置</a></dd>
                        <dd>
                            <hr>
                        </dd>
                        <dd><a id="login-out">退出登录</a></dd>
                    </dl>
                </li>
                <li id="user-login" class="layui-nav-item" lay-unselect>
                    <a href="javascript:">
                        <span><i class="fa fa-user-circle"></i> 登录</span>
                    </a>
                </li>
                <li class="layui-nav-item" lay-unselect>
                    <a href="javascript:" data-refresh="刷新"><i class="fa fa-refresh"></i></a>
                </li>
                <li class="layui-nav-item mobile layui-hide-xs" lay-unselect>
                    <a href="javascript:" data-check-screen="full"><i class="fa fa-arrows-alt"></i></a>
                </li>
                <li class="layui-nav-item layuimini-select-bgcolor" lay-unselect>
                    <a href="javascript:" data-bgcolor="配色方案"><i class="fa fa-th-list"></i></a>
                </li>
            </ul>
        </div>
    </div>

    <!--无限极左侧菜单-->
    <div class="layui-side layui-bg-black layuimini-menu-left"></div>

    <!--手机端遮罩层-->
    <div class="layuimini-make"></div>

    <!-- 移动导航 -->
    <div class="layuimini-site-mobile"><i class="layui-icon"></i></div>

    <div class="layui-body" style="padding-bottom: 0">
        <!-- 主体区域 -->
        <div class="layuimini-content-page"></div>
    </div>
</div>
<script src="module/jquery/jquery.js" charset="utf-8"></script>
<script src="module/layui/layui.js" charset="utf-8"></script>
<script src="module/xm-select/xm-select.js" charset="utf-8"></script>
<script src="module/GridManager/index.js" charset="utf-8"></script>
<script src="module/lay-config.js" charset="utf-8"></script>
<script>
    var srvPath = "/srv"
    var webPath = "/web"

    layui.use(['miniAdmin'], function () {
        var options = {
            iniUrl: "api/init.json",    // 初始化接口
            bgColorDefault: false,      // 主题默认配置
            multiModule: true,          // 是否开启多模块
            menuChildOpen: false,       // 是否默认展开菜单
            pageAnim: true,             // 切换菜单动画
        };

        layui.miniAdmin.render(options);

        $('#login-out').on("click", function () {
            $.get(srvPath + '/logout', {}, function () {
                window.location.href = webPath + "/login.html";
            });
        });
        $('#user-login a').on("click", openLoginLayer);
        updateLoginInfo();
    });

    $.ajaxSetup({
        error: function (xhr) {
            if (xhr.status === 401) {
                $('#user-profile').hide();
                $('#user-login').show();
                openLoginLayer()
            } else {
                layui.layer.msg("请求失败", {icon: 2})
            }
        }
    });

    var loginIndex = 0;

    function openLoginLayer() {
        loginIndex = loginIndex ? loginIndex : layui.layer.open({
            type: 2,
            resize: false,
            area: ['800px', '650px'],
            title: '<i class="fa fa-list"></i> 用户登录',
            content: webPath + "/login.html",
            cancel: function () {
                loginIndex = 0;
            }
        });
        return false;
    }

    function closeLoginLayer() {
        layui.layer.close(loginIndex);
    }

    function updateLoginInfo() {
        $.get(srvPath + '/loginer', {}, function (data) {
            $('#user-login').hide();
            var headImg = data.data && data.data.header ?
                '<img style="width:30px;height:30px;border-radius:15px" src="data:image;base64,' +
                data.data.header + '" alt=""/> ' : '<i class="fa fa-user-circle"></i>';
            $('#login-info').html(headImg + (data.data && data.data.name || ''));
            $('#user-profile').show();
        });
    }

    /*获取当前Url里面的参数*/
    function getUrlParams() {
        return getParamsByUrl(window.location.href);
    }

    /*获取指定Url里面的参数*/
    function getParamsByUrl(url) {
        var params = {}
        var reg = /[?&](\w+)=([^&]*)/g;
        var matches = (url || "").matchAll(reg);
        for (var match of matches) {
            params[match[1]] = decodeURIComponent(match[2]);
        }
        return params;
    }

    function encodeUriParams(params, defaults) {
        params = params || {};
        var paramStr = ""
        for (const key in params) {
            var value = params[key];
            // 如果是默认值则不添加
            if (value === defaults[key]) {
                continue
            }
            value = encodeURIComponent(value || "");
            if (value.length < 1024) {
                paramStr += value ? ((paramStr ? "&" : "") + key + "=" + value) : "";
            } else {
                console.log(paramStr + " too long");
            }
        }
        return paramStr;
    }

    // 设置当前浏览器url参数
    function setUrlParams(params, defaults) {
        var paramStr = encodeUriParams(params, defaults);
        paramStr = paramStr ? "?" + paramStr : paramStr;
        var href = window.location.href;
        var uriEnd = href.indexOf("?");
        if (uriEnd > 0) {
            href = window.location.href.substring(0, uriEnd);
        }
        window.history.replaceState({}, "", href + paramStr);
    }

    function formatDateTime(value) {
        if (value && value.length > 19) {
            value = value.substring(0, 19)
        }
        return value && value.replace("T", " ")
    }

    function gmTimeTemplate(cell, row, index, key) {
        return formatDateTime(row[key]);
    }

    function gmStrongTemplate(cell, row, index, key) {
        return '<strong>' + (row[key] || '') + '</strong>'
    }

    function gmPreTemplate(cell, row, index, key) {
        return '<pre>' + replaceHtmlTag(row[key]) + '</pre>'
    }

    function replaceHtmlTag(input) {
        return (input || "").replace(/</g, "&lt;").replace(/</g, "&gt;")
    }

    function gmAjaxTotals(settings, params) {
        return new Promise(resolve => {
            params.count = true
            $.post(settings.ajaxUrl || "", params, function (data) {
                resolve(data && data.totals || 0);
            }, 'json')
        });
    }

    function gmAjaxData(settings, params) {
        return new Promise(resolve => {
            $.post(settings.ajaxUrl || "", params, function (data) {
                resolve(data || {});
            }, 'json');
        });
    }
</script>
</body>

</html>